<!DOCTYPE html>
<html lang="en">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body {
  font-family: Arial, Helvetica, sans-serif;
  background-color:#871fff;
}

* {
  box-sizing: border-box;
}
​
/* Style inputs */
input[type=text], select, textarea {
  width: 100%;
  padding: 12px;
  border: 1px solid #ccc;
  margin-top: 6px;
  margin-bottom: 16px;
  resize: vertical;
}
​
input[type=submit] {
  background-color: #4CAF50;
  color: white;
  padding: 12px 20px;
  border: none;
  cursor: pointer;
}
​
input[type=submit]:hover {
  background-color: #45a049;
}
​
/* Style the container/contact section */
.container {
  border-radius: 5px;
  background-color: #f2f2f2;
  padding: 10px;
}
​
/* Create two columns that float next to eachother */
.column {
  float: left;
  width: 50%;
  margin-top: 6px;
  padding: 20px;
}
​
/* Clear floats after the columns */
.row:after {
  content: "";
  display: table;
  clear: both;
}
​

</style>
</head>
<body>
​<h2>Corona Survivor Reach</h2>
<div class="container">
  <div style="text-align:center">
    <h2>Chat with Prospective Donor</h2>
  </div>
  <div class="row">
    <div class="column">
    <img src="https://login.auth.vonage.com/img/img-clouds-top-big.a193b3ee.svg" style="width: 10%;
      position: absolute;
      top: 60px;
      right: 60px;">
    </div>
    <div class="column">

    <form id="login" >
        <input type="text" id="username" name="username" value="" class="textbox">
        <button type="submit">login</button>
    </form>
​    <br/> <br/>
​    <section id="chat">
        <div id="Messagefeed"></div>
        <div>
        <textarea id="messagetextarea" style="height:100px"></textarea>
        <button id="send">Send</button>
        </div>
    </section>
    
    </div>
  </div>

 


    <!-- pull in nexmo client SDK so that our chatapp can communicate with Nexmo client backend -->

    <script src="./node_modules/nexmo-client/dist/nexmoClient.js"></script>
    <script>
        /* set credentials for Alice and bob and set conversation ID */
        const profiles = [
            {
                name: "Alice",
                JWT: "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJpYXQiOjE1OTIzMTU3ODYsImp0aSI6IjJiYjRiYTkwLWFmZDktMTFlYS04MjQ4LWEzOTAxZDU3N2YyNSIsImFjbCI6eyJwYXRocyI6eyIvKi91c2Vycy8qKiI6e30sIi8qL2NvbnZlcnNhdGlvbnMvKioiOnt9LCIvKi9zZXNzaW9ucy8qKiI6e30sIi8qL2RldmljZXMvKioiOnt9LCIvKi9pbWFnZS8qKiI6e30sIi8qL21lZGlhLyoqIjp7fSwiLyovYXBwbGljYXRpb25zLyoqIjp7fSwiLyovcHVzaC8qKiI6e30sIi8qL2tub2NraW5nLyoqIjp7fX19LCJzdWIiOiJBbGljZSIsImFwcGxpY2F0aW9uX2lkIjoiZWNjOGRhNjAtMmIyZS00NzNiLWJiODEtYzc4OWQ2ZTZkOGJhIiwiZXhwIjoxNTkyNDAyMTg1fQ.S_5gc4DH_TkFBZFIcPJnsToy_3k_6_e7dkPoHHjMmJ996FTtsiWd0iVhxTW23-ms1RDdxXf1KfjvyYaUUpEjF9c4I-DHIGQULcujJPY5UfqRxN-Gu4aEUmGpNp0FTKAcIv5w0stKG5fi8iD-alXdsiJuvP39o9V3CChpzI7LUmD1MqbCPIJRVPR39TH8k7szN3BHgyIGUW-9dQ-scAihdUN1IMxqeCcA8sIBT8KfGGVPaIyiA4fA8Kxb1NiB13TwpX2aqqz5KQg3AYfYLzPORhlzw6JOITxv9gEyCn2STiC5Ew4OVjLrNlI9OXjTM8553aHTvP6UkFAeLVVRZ6mCSg",
                blood: "A+",
                city: "London",
                country: "UK",
                phone: "447460301777"

            },
            {
                name: "Bob",
                JWT: "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJpYXQiOjE1OTIzMTU4MzcsImp0aSI6IjRhM2QzMjMwLWFmZDktMTFlYS1hNmU4LTQ3YjRkNzk5ZDQ5OCIsImFjbCI6eyJwYXRocyI6eyIvKi91c2Vycy8qKiI6e30sIi8qL2NvbnZlcnNhdGlvbnMvKioiOnt9LCIvKi9zZXNzaW9ucy8qKiI6e30sIi8qL2RldmljZXMvKioiOnt9LCIvKi9pbWFnZS8qKiI6e30sIi8qL21lZGlhLyoqIjp7fSwiLyovYXBwbGljYXRpb25zLyoqIjp7fSwiLyovcHVzaC8qKiI6e30sIi8qL2tub2NraW5nLyoqIjp7fX19LCJzdWIiOiJCb2IiLCJhcHBsaWNhdGlvbl9pZCI6ImVjYzhkYTYwLTJiMmUtNDczYi1iYjgxLWM3ODlkNmU2ZDhiYSIsImV4cCI6MTU5MjQwMjIzNn0.BSjvnKO75mU6jGExu7LJjzh5hPI3eSB-VGOZGKEuSrLhR2hQt6ysfCkHMuws83HQUHosmDkzQua7XSXMtHVy5WasIxhVzUebIIxLoeH5vEDtLm9jXnYVvoW6o86j5W66QhqKDQBM6uDlgmgge9JfH2d3LIkqOEmOE9ODAqcP4o05XwniP9xvGNO8SmIZz4DNbe4JKX2fnQX9Fo0bmrk_YbJC6JMBEdSWcD_0l7RgprDazH5nnj_ExvredrdWpKhyMllQfzDX7ktNMYXmeFPIpevT_BCPb-sxRIbmKEMgF5FRDF4H7lTfAt5h0QmFIYq_JMw1kfWhC-Wywl1UGB03Pg",
                blood: "B",
                city: "London",
                country: "UK",
                phone: "447547113295"
            }

        ]

        const CONVERSATION_ID= "CON-e8fc99be-0301-4ab4-a11e-72bcb02bd068";
        //Reference to elements

        const loginForm = document.getElementById("login");
        const username = document.getElementById("username");
        const messageTextarea = document.getElementById("messagetextarea");
        const messageFeed = document.getElementById("Messagefeed");
        const sendButton = document.getElementById("send");
        // Authenticate the user
        function authenticate(username){
            const user = profiles.find(function (p) {
                return p.name==username;
            })
            if (user) {
                return user.JWT
            }
            else {
                alert("user does not exist");
            }
        }
        // Adding event listner for button

        loginForm.addEventListener("submit",(event)=>{
            event.preventDefault() // so that page does not reload
            const userToken = authenticate(username.value);
            if (userToken){
                //initialise the chat
                initializeChat(userToken);
            }
        });
            async function initializeChat(userToken)
            {
                const client = new NexmoClient({debug: true}); // to see debug messages in console
                
                const app =await client.login(userToken);
                const conversation = await app.getConversation(CONVERSATION_ID);
                //load messages that happned before page loaded
                const initialMessages = await conversation.getEvents({event_type:"text", page_size:100, order:'asc'});

                initialMessages.items.forEach(message =>{
                    //format messages and add to message feed
                    formatAndAddMessage(conversation.members.get(message.from), message, conversation.me);
                });
                //any time there is a new text event, add it as  a message
                conversation.on("text", (sender,event)=>{
                    // format messages and add to message feed
                    formatAndAddMessage(sender, event, conversation.me);

                });
                //listen for clicks on send button and listen for existing text value
                sendButton.addEventListener("click", async()=>{

                    //get list of all users other than initiator 
                    //and send each an sms message
                   
                    profiles.forEach(async (profile) => {
                        if(profile.name != username.value){
                            const data = {
                                phone: profile.phone,
                                text: messageTextarea.value
                            }

                        await fetch('http://localhost:3000/sms', {
                                method: 'POST',
                                mode: 'cors',
                                credentials: 'same-origin',
                                headers: {
                                'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(data )
                            });
                        }
                    });

                await conversation.sendText(messageTextarea.value);
                messageTextarea.value = "";
                });
            }
                function formatAndAddMessage(sender, message, me){
                    let text = "";
                    //format message
                    if (message.from !== me.id){
                            text = '<span style = "color:red">'+sender.user.name+' : <b>'+message.body.text+'</b></span>';
                                
                        }
                        else {
                            text = 'me : <b>'+message.body.text+'</b>';
                        }
                         // Add message
                        messageFeed.innerHTML += text + "<br />";
                         }


    </script>
    
</body>
</html>